# æ–‡ä»¶è¯´æ˜

ç†è§£epollåŸç†ï¼Œå› ä¸ºepollæ˜¯åœ¨Linuxä¸Šçš„å®ç°æ–¹å¼ï¼Œåœ¨Mac osä¸Šä½¿ç”¨äº†å…¨æ–°çš„æ–¹å¼kqueueï¼Œæ‰€ä»¥å°è¯•å¤šå†™ä¸€ä¸ªkqueueçš„æ§åˆ¶æ–¹å¼

[æ–‡æ¡£ğŸ“„](https://github.com/ShawnZL/Socket_Learning/blob/master/TCP_Reading.md)

## è¿è¡Œæ–¹æ³•

```shell
gcc server.c -o serv
./serv 9190
```

# epoll

Selectå¤ç”¨æœåŠ¡å™¨ï¼Œ è°ƒç”¨selectä¸¤æ•°åï¼Œå¹¶ä¸æ˜¯æŠŠå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦å•ç‹¬é›†ä¸­åˆ°ä¸€èµ·ï¼Œè€Œæ˜¯é€šè¿‡è§‚å¯Ÿä½œä¸ºç›‘è§†å¯¹è±¡çš„fd_ set å˜é‡çš„ å˜åŒ– ï¼Œ æ‰¾å‡ºå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤æ— æ³•é¿å…é’ˆå¯¹æ‰€æœ‰ç›‘è§†å¯¹è±¡çš„å¾ªç¯è¯­å¥ã€‚åŒæ—¶è¿˜ç‰µæ‰¯åˆ°äº†å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆç”±ç”¨æˆ·æ€æ”¾è¿›å†…æ ¸æ€è¿›è¡Œç›‘å¬ï¼Œç„¶åä¸æ–­è½®è¯¢ï¼Œå†å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆä»å†…æ ¸å¤åˆ¶å‡ºè¿›è¡Œå¤„ç†ã€‚

```c
typedef union epoll_data
{
  void *ptr;
  int fd;
  uint32_t u32;
  uint64_t u64;
} epoll_data_t;

struct epoll_event
{
  uint32_t events;  /* Epoll events */
  epoll_data_t data;    /* User data variable */
};
```

å£°æ˜è¶³å¤Ÿå¤§çš„epoll_eventç»“æ„ä½“æ•°ç»„åï¼Œä¼ é€’ç»™epoll_waitå‡½æ•°ï¼Œå‘ç”Ÿå˜åŒ–çš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯å°†è¢«å¡«å…¥è¯¥æ•°ç»„ã€‚

```c
int epoll_create(int size); // size epoll å¤§å°
int epoll_ctl(int epfd, int op, int fd, struct epoll_event* event);
// epfd ç”¨äºæ³¨å†Œç›‘è§†å¯¹è±¡çš„epollä¾‹ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦
// op ç”¨äºæŒ‡å®šç›‘è§†å¯¹è±¡çš„æ·»åŠ ã€åˆªé™¤æˆ–æ›´æ”¹ç­‰æ“ä½œã€‚
// fd éœ€è¦æ³¨å†Œçš„ç›‘è§†å¯¹è±¡æ–‡ä»¶æè¿°ç¬¦ã€‚
// event ç›‘è§†å¯¹è±¡çš„äº‹ä»¶ç±»å‹ã€‚
int epoll_wait(int epfd, struct epoll_event* event, int maxevent, int timeout);
// epfd ç”¨äºæ³¨å†Œç›‘è§†å¯¹è±¡çš„epollä¾‹ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦
// event ç›‘è§†å¯¹è±¡çš„äº‹ä»¶ç±»å‹ã€‚
// maxevent å¯ä»¥ä¿å­˜çš„æœ€å¤§äº‹ä»¶æ•°ç›®
// timeout ä»¥1/1000ç§’ä¸ºå•ä½çš„ç­‰å¾…æ—¶é—´ï¼Œä¼ é€’-1æ—¶ï¼Œä¸€ç›´ç­‰å¾…ç›´åˆ°å‘ç”Ÿäº‹ä»¶ã€‚
```

## æ°´å¹³è§¦å‘ï¼ˆæ¡ä»¶Levelï¼‰ä¸å‚ç›´è§¦å‘ï¼ˆè¾¹ç¼˜Edgeï¼‰

æ¡ä»¶è§¦å‘æ–¹å¼ä¸­ï¼Œåªè¦è¾“å…¥ç¼“å†²æœ‰æ•°æ®å°±ä¼š ä¸€ç›´é€šçŸ¥è¯¥äº‹ä»¶ã€‚

è¾¹ç¼˜è§¦å‘ä¸­è¾“äººç¼“å†²æ”¶åˆ°æ•°æ®æ—¶ä»…æ³¨å†Œ1æ¬¡è¯¥äº‹ä»¶ã€‚å³ä½¿è¾“äººç¼“å†²ä¸­è¿˜ç•™æœ‰æ•°æ®ï¼Œä¹Ÿä¸ä¼šå†è¿›è¡Œæ³¨å†Œã€‚

## å‚ç›´è§¦å‘

é€šè¿‡errnoå˜é‡éªŒè¯é”™è¯¯åŸå› 

ä¸ºäº†å®Œæˆéé˜»å¡IOï¼Œæ›´æ”¹å¥—æ¥å­—ç‰¹æ€§

```c
int fcntl(int filedes, int cmd, ...);
// filedes å±æ€§æ›´æ”¹ç›®æ ‡çš„æ–‡ä»¶æè¿°ç¬¦
// cmd è¡¨ç¤ºå‡½æ•°è°ƒç”¨çš„ç›®çš„

int flag = fcntl(fd, F_GETFL, 0);
fcntl(fd, F_SETFL, flag|O_NONBLOCK);
```

**å¯ä»¥åˆ†ç¦»æ¥æ”¶æ•°æ®å’Œå¤„ç†æ•°æ®çš„æ—¶é—´ç‚¹!**

